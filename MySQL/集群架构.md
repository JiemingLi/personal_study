# 主从模式

MysQL主从模式是指数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点。MySQL默认采用异
步复制方式，这样从节点不用一直访问主服务器来更新自己的数据，从节点可以复制主数据库中的所有数据库，或
者特定的数据库，或者特定的表。

![img](https://blog.rubinchu.com/wp-content/uploads/2021/10/2-9.png)



主从复制整体分为以下三个步骤：

- 主库将数据库的变更操作记录到Binlog日志文件中
- 从库读取主库中的Binlog日志文件信息写入到从库的Relay Log中继日志中
- 从库读取中继日志信息在从库中进行Replay,更新从库数据信息

在上述三个过程涉及了Master的BinlogDump Thread和Slave的I/O Thread、SQL Thread，它们的作用如下：

- Master服务器对数据库更改操作记录在Binlog中，BinlogDump Thread接到写入请求后，读取Binlog信息推送给Slave的I/O Thread。
- Slave的I/O Thread将读取到的Binlog信息写入到本地Relay Log中。
- Slave的SQL Thread检测到Relay Log的变更请求，解析relay log中内容在从库上执行

上述过程都是**异步操作**，俗称**异步复制**，**存在数据延迟现象**。

![img](https://blog.rubinchu.com/wp-content/uploads/2021/10/3-7-1024x444.png)

主从复制带来的问题

- 在数据发送之后，主库宕机后，数据可能丢失。
- 从库只有一个SQL Thread，主库写压力大，复制很可能延时

解决办法

- 半同步复制（解决数据丢失的问题）
- 并行复制（解决从库复制延迟问题）

## 半同步复制

为了提升数据安全，MySQL让Master在<u>某一个时间点</u>等待Slave节点的 ACK（Acknowledge character）消息，接收到ACK消息后才进行事务提交，这也是半同步复制的基础，MySQL从5.5版本开始引入了半同步复制机制来**降低数据丢失的概率**。

MySQL 事务写入碰到主从复制时的完整过程，主库事务写入分为 4个步骤：

- InnoDB Redo File Write (Prepare Write)
- Binlog File Flush & Sync to Binlog File
- InnoDB Redo File Commit（Commit Write）
- Send Binlog to Slave（异步发送）

当Master不需要关注Slave是否接受到Binlog Event时，即为传统的主从复制。

当Master需要在第三步等待Slave返回ACK时，即为 after-commit，半同步复制（**MySQL 5.5引入**）。

当Master需要在第二步等待 Slave 返回 ACK 时，即为 after-sync，增强半同步（**MySQL 5.7引入**）。

------

没有收到ack可能会有这2种情况：

1， slave没接收到binlog，所以一直没回

2， slave收到binlog并且成功写入，返回给master的时候丢失。

after-commit在情况2的时候，master在没收到ack的情况重新发送，会出现slave重复提交数据的情况，after-sync只有在slave同步后，master再提交，可以避免情况2；

主库等待从库写入 relay log 并返回 ACK 后才进行Engine Commit，如下图所示

![img](https://blog.rubinchu.com/wp-content/uploads/2021/10/4-7-1024x448.png)